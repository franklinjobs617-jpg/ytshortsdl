<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>yt-dlp è§†é¢‘æ ¼å¼æŸ¥è¯¢ä¸ä¸‹è½½</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Tailwind CSS é…ç½® (ç”¨äºé¢œè‰²å’Œå­—ä½“)
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#3b82f6',
                        'primary-dark': '#2563eb',
                        'success': '#10b981',
                        'error': '#ef4444',
                        'warning': '#f59e0b',
                    }
                }
            }
        }
    </script>
    <style>
        /* ä½¿è¡¨æ ¼åŒºåŸŸçš„æ»šåŠ¨æ¡æ›´ç¾è§‚ */
        .format-list::-webkit-scrollbar {
            width: 8px;
        }

        .format-list::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 10px;
        }

        .format-list::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
    </style>
    <meta name="google-adsense-account" content="ca-pub-3383070348689557">

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3383070348689557"
        crossorigin="anonymous"></script>
</head>

<body class="bg-gray-50 p-4 sm:p-8 font-sans">

    <div class="container max-w-4xl mx-auto bg-white p-6 sm:p-10 shadow-xl rounded-xl">
        <h2 class="text-3xl font-bold text-primary mb-6 border-b-2 border-primary pb-3">
            ğŸš€ è§†é¢‘æ ¼å¼æŸ¥è¯¢ä¸ä¸‹è½½å·¥å…·
        </h2>
        <p class="text-gray-600 mb-6">
            è¯·è¾“å…¥è§†é¢‘é“¾æ¥ï¼ŒæŸ¥è¯¢å¯ç”¨æ ¼å¼åé€‰æ‹©ä¸‹è½½åˆ°æœåŠ¡å™¨è¿›è¡Œå¤„ç†ã€‚
        </p>

        <div class="flex flex-col sm:flex-row gap-4 mb-8">
            <input type="text" id="videoUrl" placeholder="è¾“å…¥è§†é¢‘é“¾æ¥ï¼Œä¾‹å¦‚ï¼šhttps://www.youtube.com/watch?v=..."
                class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition duration-150">
            <button onclick="fetchVideoInfo()"
                class="bg-primary hover:bg-primary-dark text-white font-semibold py-3 px-6 rounded-lg transition duration-150 shadow-md hover:shadow-lg disabled:opacity-50"
                id="queryButton">
                æŸ¥è¯¢æ ¼å¼ä¿¡æ¯
            </button>
        </div>

        <div id="statusMessage"
            class="p-4 rounded-lg font-medium text-white bg-success mb-6 transition-all duration-300">
            ç­‰å¾…è¾“å…¥...
        </div>

        <h3 class="text-xl font-semibold text-gray-800 mb-4">å¯ç”¨æ ¼å¼åˆ—è¡¨</h3>

        <div class="format-list max-h-96 overflow-y-auto border border-gray-200 rounded-lg shadow-inner">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50 sticky top-0">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            åˆ†è¾¨ç‡/éŸ³é¢‘
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            æ ¼å¼ ID
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            ç¼–ç  (è§†é¢‘/éŸ³é¢‘)
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            æ–‡ä»¶å¤§å°
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            æ“ä½œ
                        </th>
                    </tr>
                </thead>
                <tbody id="formatsBody" class="bg-white divide-y divide-gray-200">
                    <tr>
                        <td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500">è¯·å…ˆæŸ¥è¯¢è§†é¢‘ä¿¡æ¯...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // ç¡®ä¿è¿™é‡Œçš„ IP åœ°å€å’Œç«¯å£ä¸æ‚¨çš„ Flask åç«¯å®Œå…¨ä¸€è‡´ï¼
        const API_BASE_URL = 'http://127.0.0.1:5000';
        const API_FORMATS_ENDPOINT = `${API_BASE_URL}/api/video-formats`;
        const API_DOWNLOAD_ENDPOINT = `${API_BASE_URL}/api/download`;

        let currentVideoUrl = '';

        /**
         * æ›´æ–°çŠ¶æ€æ æ¶ˆæ¯
         */
        function updateStatus(message, type = 'success') {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.className = `p-4 rounded-lg font-medium text-white mb-6 transition-all duration-300 bg-${type}`;
            statusMessage.textContent = message;
        }

        /**
         * å°†å­—èŠ‚æ•°è½¬æ¢ä¸ºæ˜“è¯»æ ¼å¼ (KB, MB, GB)
         */
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0 || bytes === null || bytes === undefined) return 'æœªçŸ¥';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];

            const i = Math.floor(Math.log(bytes) / Math.log(k));
            if (i < 0) return 'æœªçŸ¥';
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        /**
         * 1. è°ƒç”¨åç«¯ API è·å–è§†é¢‘ä¿¡æ¯
         */
        async function fetchVideoInfo() {
            const urlInput = document.getElementById('videoUrl');
            const formatsBody = document.getElementById('formatsBody');
            const queryButton = document.getElementById('queryButton');
            currentVideoUrl = urlInput.value.trim();

            if (!currentVideoUrl) {
                updateStatus('é”™è¯¯ï¼šè¯·è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆçš„è§†é¢‘é“¾æ¥ã€‚', 'error');
                return;
            }

            queryButton.disabled = true;
            updateStatus('æ­£åœ¨æŸ¥è¯¢æ ¼å¼ä¿¡æ¯ï¼Œè¯·ç¨å€™...', 'warning');
            formatsBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-sm text-warning">æ­£åœ¨è¯·æ±‚åç«¯...</td></tr>';

            try {
                const response = await fetch(API_FORMATS_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: currentVideoUrl })
                });

                const data = await response.json();
                queryButton.disabled = false;

                if (response.ok) {
                    updateStatus(`æŸ¥è¯¢æˆåŠŸï¼è§†é¢‘æ ‡é¢˜: ${data.title}`, 'success');
                    renderFormatsTable(data.formats);
                } else {
                    updateStatus(`æŸ¥è¯¢å¤±è´¥ (${response.status}): ${data.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                    formatsBody.innerHTML = `<tr><td colspan="5" class="px-6 py-4 text-center text-sm text-error">${data.error || 'æ— æ³•åŠ è½½æ ¼å¼'}</td></tr>`;
                }

            } catch (error) {
                queryButton.disabled = false;
                updateStatus('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦å·²è¿è¡Œå¹¶ç›‘å¬æ­£ç¡®çš„ IP/ç«¯å£ã€‚', 'error');
                formatsBody.innerHTML = `<tr><td colspan="5" class="px-6 py-4 text-center text-sm text-error">è¯·æ±‚å¤±è´¥: ${error.message}</td></tr>`;
            }
        }

        /**
         * 2. æ¸²æŸ“æ ¼å¼è¡¨æ ¼
         */
        function renderFormatsTable(formats) {
            const formatsBody = document.getElementById('formatsBody');
            formatsBody.innerHTML = ''; // æ¸…ç©ºè¡¨æ ¼å†…å®¹

            if (formats.length === 0) {
                formatsBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-sm text-warning">æœªæ‰¾åˆ°å¯ç”¨çš„è§†é¢‘æ ¼å¼ã€‚</td></tr>';
                return;
            }

            formats.forEach(format => {
                const row = formatsBody.insertRow();
                row.className = 'hover:bg-gray-50';

                // åˆ†è¾¨ç‡/éŸ³é¢‘
                row.insertCell().textContent = `${format.resolution || 'N/A'} (${format.ext})`;

                // æ ¼å¼ ID
                row.insertCell().textContent = format.format_id;

                // ç¼–ç 
                row.insertCell().textContent = `${format.vcodec !== 'none' ? format.vcodec : 'æ— è§†é¢‘'} / ${format.acodec !== 'none' ? format.acodec : 'æ— éŸ³é¢‘'}`;

                // æ–‡ä»¶å¤§å°
                row.insertCell().textContent = formatBytes(format.filesize);

                // æ“ä½œ (ä¸‹è½½æŒ‰é’®)
                const actionCell = row.insertCell();
                actionCell.className = 'px-6 py-4 whitespace-nowrap text-sm font-medium';
                const button = document.createElement('button');
                button.textContent = 'ä¸‹è½½åˆ°æœ¬åœ°';
                button.type = 'button';
                button.onclick = () => downloadVideo(format.format_id, button);
                button.className = 'download-btn bg-success hover:bg-green-600 text-white py-2 px-4 rounded-lg text-xs font-semibold transition duration-150 shadow-md';
                actionCell.appendChild(button);
            });
        }

        /**
         * 3. è°ƒç”¨åç«¯ API è§¦å‘ä¸‹è½½
         */
        async function downloadVideo(formatId, button) {
            // ç¦ç”¨æ‰€æœ‰ä¸‹è½½æŒ‰é’®
            document.querySelectorAll('.download-btn').forEach(btn => btn.disabled = true);
            const originalText = button.textContent;

            // ä¸´æ—¶æ”¹å˜æŒ‰é’®æ ·å¼å’Œæ–‡æœ¬ï¼Œè¡¨ç¤ºæ­£åœ¨å¤„ç†
            button.textContent = 'å¤„ç†ä¸­...';
            button.classList.remove('bg-success');
            button.classList.add('bg-gray-400');

            updateStatus(`æ­£åœ¨è¯·æ±‚åç«¯å¤„ç†æ ¼å¼ ID: ${formatId}ï¼Œè¯·è€å¿ƒç­‰å¾…æ–‡ä»¶åˆå¹¶...`, 'warning');

            try {
                // ç¬¬ä¸€æ­¥ï¼šè¯·æ±‚åç«¯åœ¨æœåŠ¡å™¨ä¸Šä¸‹è½½å¹¶åˆå¹¶æ–‡ä»¶
                const response = await fetch(API_DOWNLOAD_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        url: currentVideoUrl,
                        format_id: formatId
                    })
                });

                const data = await response.json();
                function triggerDownload(downloadUrl) {
                    // 1. åˆ›å»ºä¸€ä¸ªéšè—çš„ <a> æ ‡ç­¾
                    const link = document.createElement('a');
                    link.href = API_BASE_URL + downloadUrl;

                    // 2. è®¾ç½® download å±æ€§ï¼Œç¡®ä¿æµè§ˆå™¨å¼¹å‡ºä¿å­˜å¯¹è¯æ¡†
                    // æ³¨æ„: download å±æ€§çš„å€¼ä¼šè¢«ç”¨ä½œé»˜è®¤æ–‡ä»¶å (ç°ä»£æµè§ˆå™¨ä¸­)
                    link.setAttribute('download', 'video_download');

                    // 3. å°†é“¾æ¥æ·»åŠ åˆ°DOMï¼Œå¹¶æ¨¡æ‹Ÿç‚¹å‡»
                    document.body.appendChild(link);
                    link.click();

                    // 4. æ¸…ç†DOM
                    document.body.removeChild(link);
                }
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                document.querySelectorAll('.download-btn').forEach(btn => btn.disabled = false);
                button.textContent = originalText;
                button.classList.remove('bg-gray-400');
                button.classList.add('bg-success');

                if (response.ok) {
                    updateStatus(`æœåŠ¡å™¨å¤„ç†æˆåŠŸï¼æ–‡ä»¶å·²å‡†å¤‡å¥½ã€‚æ­£åœ¨è‡ªåŠ¨è§¦å‘æ‚¨çš„æµè§ˆå™¨ä¸‹è½½...`, 'success');
                    console.log(data);
                    // è§¦å‘æµè§ˆå™¨ä¸‹è½½
                    triggerDownload(data.download_url);

                } else {
                    updateStatus(`ä¸‹è½½å¤„ç†å¤±è´¥ (${response.status}): ${data.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }

            } catch (error) {
                // æ¢å¤æŒ‰é’®çŠ¶æ€ï¼ˆå³ä½¿è¯·æ±‚å¤±è´¥ï¼‰
                document.querySelectorAll('.download-btn').forEach(btn => btn.disabled = false);
                button.textContent = originalText;
                button.classList.remove('bg-gray-400');
                button.classList.add('bg-success');
                updateStatus('ä¸‹è½½è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œå’Œåç«¯çŠ¶æ€ã€‚', 'error');
            }
        }
    </script>

</body>

</html>